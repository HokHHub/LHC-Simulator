{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import fs from \"node:fs\";\nimport path from \"node:path\";\nimport type {Plugin, ResolvedConfig, Logger} from \"vite\";\n\n/**\n * ---------------------------------------------------------------------------\n *  Vite Plugin: vite-plugin-robots-txt\n *  - Emits robots.txt in build\n *  - Serves robots.txt in dev with no-store\n *  - Optional mirror to disk via outputDir (both dev & prod)\n *  - Unified style, Vite logger, no external helpers\n * ---------------------------------------------------------------------------\n */\n\n/** One user-agent block */\nexport type RobotsPolicy = {\n    userAgent?: string;   // default \"*\"\n    allow?: string[];\n    disallow?: string[];\n};\n\nexport type RobotsOptions = {\n    filename?: string; // default \"robots.txt\"\n\n    // Static policies (wins over builder if provided and non-empty)\n    policies?: RobotsPolicy[];\n\n    // Build from current ctx\n    policyBuilder?: (ctx: { mode: string; command: \"serve\" | \"build\"; root: string }) => RobotsPolicy[];\n\n    // Sitemaps\n    sitemaps?: string[] | ((ctx: { mode: string; command: \"serve\" | \"build\"; root: string }) => string[] | undefined);\n\n    // Footer as comment\n    footerComment?: string | ((ctx: { mode: string; command: \"serve\" | \"build\"; root: string }) => string | undefined);\n\n    // Control dev caching\n    noStoreInDev?: boolean; // default true\n\n    // Optional disk mirror (dev & prod)\n    outputDir?: string;\n};\n\n// ----------------- utils -----------------\n\nconst DEFAULT_FILENAME = \"robots.txt\";\n\nfunction uniq<T>(arr?: T[]) {\n    return Array.from(new Set(arr ?? []));\n}\n\nfunction lines(...xs: Array<string | null | undefined | false>) {\n    return xs.filter(Boolean).map((x) => String(x));\n}\n\nfunction serializePolicies(policies: RobotsPolicy[]) {\n    const blocks: string[] = [];\n\n    for (const p of policies) {\n        const ua = (p.userAgent ?? \"*\").trim() || \"*\";\n        const dis = uniq(p.disallow).map((d) => `Disallow: ${d}`);\n        const allow = uniq(p.allow).map((a) => `Allow: ${a}`);\n        const block = lines(`User-agent: ${ua}`, ...dis, ...allow, \"\").join(\"\\n\");\n        blocks.push(block);\n    }\n\n    return blocks.join(\"\\n\").trimEnd() + \"\\n\";\n}\n\n/** Default policy = allow all */\nfunction defaultPolicies(): RobotsPolicy[] {\n    return [{userAgent: \"*\", allow: [\"/\"], disallow: []}];\n}\n\nfunction buildContent(\n    ctx: { mode: string; command: \"serve\" | \"build\"; root: string },\n    opts: RobotsOptions\n) {\n    const policies =\n        (opts.policies && opts.policies.length ? opts.policies : undefined) ??\n        (opts.policyBuilder ? opts.policyBuilder(ctx) : undefined) ??\n        defaultPolicies();\n\n    const head = serializePolicies(policies);\n\n    const sitemaps =\n        typeof opts.sitemaps === \"function\"\n            ? opts.sitemaps(ctx)\n            : Array.isArray(opts.sitemaps)\n                ? opts.sitemaps\n                : undefined;\n    const smBlock = sitemaps?.length ? sitemaps.map((u) => `Sitemap: ${u}`).join(\"\\n\") + \"\\n\" : \"\";\n\n    const foot = typeof opts.footerComment === \"function\" ? opts.footerComment(ctx) : opts.footerComment ?? undefined;\n    const footerBlock = foot ? `\\n# ${foot.trim()}\\n` : \"\";\n\n    return (head + (smBlock ? `\\n${smBlock}` : \"\") + footerBlock).replace(/\\n{3,}$/g, \"\\n\\n\");\n}\n\nasync function writeFileIfChanged(filePath: string, content: string, logger: Logger) {\n    try {\n        const existed = fs.existsSync(filePath);\n        const prev = existed ? await fs.promises.readFile(filePath, \"utf8\") : null;\n        if (prev === content) {\n            logger.info?.(`[robots] no changes: ${filePath}`);\n            return false;\n        }\n    } catch {\n        // ignore\n    }\n    await fs.promises.mkdir(path.dirname(filePath), {recursive: true});\n    await fs.promises.writeFile(filePath, content, \"utf8\");\n    logger.info(`[robots] wrote ${filePath}`);\n    return true;\n}\n\n// ----------------- Vite plugin -----------------\n\nexport function generateRobotsTxt(options: RobotsOptions = {}): Plugin {\n    const filename = options.filename ?? DEFAULT_FILENAME;\n    const noStoreInDev = options.noStoreInDev ?? true;\n\n    let resolvedConfig!: ResolvedConfig;\n    let logger!: Logger;\n    let mode = \"production\";\n    let command: \"serve\" | \"build\" = \"build\";\n    let root = process.cwd();\n\n    const buildTxt = () => {\n        const ctx = {mode, command, root};\n        return buildContent(ctx, options);\n    };\n\n    return {\n        name: \"vite-plugin-robots-txt\",\n        apply: () => true,\n\n        configResolved(config) {\n            resolvedConfig = config;\n            logger = config.logger;\n            root = config.root ?? process.cwd();\n            mode = config.mode;\n            command = config.command as \"serve\" | \"build\";\n        },\n\n        async buildStart() {\n            const txt = buildTxt();\n            if (options.outputDir) {\n                const outPath = path.resolve(root, options.outputDir, filename);\n                await writeFileIfChanged(outPath, txt, logger);\n            }\n        },\n\n        generateBundle() {\n            const txt = buildTxt();\n            this.emitFile({type: \"asset\", fileName: filename, source: txt});\n            logger.info(`[robots] emitted ${filename}`);\n        },\n\n        configureServer(server) {\n            const base = (resolvedConfig?.base ?? \"/\").replace(/\\/+$/, \"/\");\n            const route = base + filename;\n\n            server.middlewares.use(route, (_req, res) => {\n                const txt = buildTxt();\n\n                res.setHeader(\"Content-Type\", \"text/plain; charset=utf-8\");\n                if (noStoreInDev) {\n                    res.setHeader(\"Cache-Control\", \"no-store, no-cache, must-revalidate, max-age=0\");\n                    res.setHeader(\"Pragma\", \"no-cache\");\n                    res.setHeader(\"Expires\", \"0\");\n                }\n                res.end(txt);\n            });\n\n            logger.info(`[robots] dev route mounted â†’ ${route} (no-store)`);\n        },\n    };\n}\n\nexport default generateRobotsTxt;\n"]}